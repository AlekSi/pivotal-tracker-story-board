<!--
/**
 *  The MIT License
 *
 *  Copyright (c) 2010 Simone Vicentini
 *
 *  Permission is hereby granted, free of charge, to any person obtaining a copy
 *  of this software and associated documentation files (the "Software"), to deal
 *  in the Software without restriction, including without limitation the rights
 *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 *  copies of the Software, and to permit persons to whom the Software is
 *  furnished to do so, subject to the following conditions:
 *
 *  The above copyright notice and this permission notice shall be included in
 *  all copies or substantial portions of the Software.
 *
 *  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 *  THE SOFTWARE.
 */
 -->
<html>
<head>
<title>Pivotal Tracker Story Board</title>
<LINK href="css/storyBoard.css" rel="stylesheet" type="text/css">
<script src="scripts/mootools-1.2.4-core-jm.js"></script>
<script src="scripts/StoryBoard.js"></script>
<script src="scripts/StoryColumn.js"></script>
<script src="scripts/StoryCard.js"></script>
<script src="scripts/ErrorDialog.js"></script>
<script src="scripts/Loader.js"></script>
<script src="scripts/PivotalTrackerAPIClient.js"></script>
<script>


function getOffset( el ) {
    var _x = 0;
    var _y = 0;
    while( el && !isNaN( el.offsetLeft ) && !isNaN( el.offsetTop ) ) {
        _x += el.offsetLeft;
        _y += el.offsetTop;
        el = el.parentNode;
    }
    return { top: _y, left: _x };
}

function getURLParam(strParamName)
{
    var strReturn = "";
    var strHref = window.location.href;
    if ( strHref.indexOf("?") > -1 )
    {
        var strQueryString = strHref.substr(strHref.indexOf("?")).toLowerCase();
        var aQueryString = strQueryString.split("&");
        for ( var iParam = 0; iParam < aQueryString.length; iParam++ )
        {
            if (aQueryString[iParam].indexOf(strParamName.toLowerCase() + "=") > -1 )
            {
                  var aParam = aQueryString[iParam].split("=");
                strReturn = aParam[1];
                break;
            }
        }
    }
    return unescape(strReturn);
}

function onProjectLoaded(responseText, responseXML)
{
    loader.hideLoader();
    var project = responseXML.getElementsByTagName("project");
    var title = $('title');
    title.set('html',getTextContentForElement(project[0], "name"));
}



function onRequestStart()
{
    loader.showLoader();
}

function onXmlRequestError(xhr)
{
    var message = "OOPS!! Something went wrong!<BR>";
    if (xhr.responseText != undefined)
        message += xhr.responseText + "<BR>";
    message += "STATUS: "+xhr.status;

    if (xhr.status == 422)
        message += "<br>Make sure you've set the correct API token for this user. Check it in the <a href='options.html' target='_blank'>options page</a>";
    else if ((xhr.status == 0))
        message += "<br>Try and refresh the page!";
    else
        message += "<br>Have you set the API Token in the <a href='options.html' target='_blank'>options page</a> of the extension?<br>";

    errorDialog.showError(message);
}

function onStoriesLoaded(responseText, responseXML)
{
    loader.hideLoader();
    storyBoard.clear();
    var stories = responseXML.getElementsByTagName("story");
    var i = 0;
    for (var i=0; i < stories.length; i++)
    {
        var story = stories[i];
        var state = getTextContentForElement(story, "current_state");

        if (state == "accepted" || state == "rejected")
            continue;

        var storyCard = new StoryCard(getTextContentForElement(story, "name"),
                                      getTextContentForElement(story, "current_state"),
                                      getTextContentForElement(story, "story_type"),
                                      getTextContentForElement(story, "owned_by"),
                                      getTextContentForElement(story, "estimate"));
        storyBoard.addStory(storyCard);
    }

    var timeout = localStorage["storyBoard-refreshTimeout"];
    if (timeout == undefined || timeout == "")
        timeout = 15;

    startStoriesTimer.bind(document).delay(timeout * 60 * 1000);
}

function startStoriesTimer()
{
    pivotalClient.getStories(projectId, storiesFilter, onRequestStart, onStoriesLoaded, onXmlRequestError);
}

function getTextContentForElement(src, elementTag)
{
    var elements = src.getElementsByTagName(elementTag);
    if (elements.length > 0)
        return elements[0].textContent;
    return "";
}

</script>

</head>
<body>


<img id="chore" src="images/chore_icon.png" style="display:none">
<img id="feature" src="images/feature_icon.png"  style="display:none">



<div id="title">
Project name
</div>

<div style="display:block;width:100%;margin:0px;padding:0px;line-height:16px">
<table id="storyBoardTable">
</table>
</div>
<div id="footer">
<a href="http://blog.vizio360.co.uk" target="_blank">&nbsp&nbsp© 2010 vizio 360&nbsp&nbsp</a>
</div>
<div id="loader">
    <img id="loader_image" src="images/loader.gif">
</div>
<div id="error">
Error!
</div>

<script>

var errorDialog = new ErrorDialog($('error'));

var loader = new Loader($('loader'), 500);


var storyBoard = new StoryBoard('storyBoardTable');


var unstartedCol = new StoryColumn('unstarted');
unstartedCol.setTitle(storyBoard.getLabelForStoryState("unstarted"));
storyBoard.addStoryColumn(unstartedCol);

var startedCol = new StoryColumn('started');
startedCol.setTitle(storyBoard.getLabelForStoryState("started"));
storyBoard.addStoryColumn(startedCol);

var finishedCol = new StoryColumn('finished');
finishedCol.setTitle(storyBoard.getLabelForStoryState("finished"));
storyBoard.addStoryColumn(finishedCol);

var deliveredCol = new StoryColumn('delivered');
deliveredCol.setTitle(storyBoard.getLabelForStoryState("delivered"));
storyBoard.addStoryColumn(deliveredCol);


var token = localStorage["storyBoard-X-Tracker-Token"];
var pivotalClient = new PivotalTrackerAPIClient(token, getURLParam('useHttps'));
var projectId = getURLParam('projectId');
pivotalClient.getProject(projectId, onRequestStart, onProjectLoaded, onXmlRequestError);
//var storiesFilter = "filter=state:unstarted,started,finished,delivered";
pivotalClient.getCurrentIterationStories(projectId, onRequestStart, onStoriesLoaded, onXmlRequestError);

</script>

</body>
</html>
