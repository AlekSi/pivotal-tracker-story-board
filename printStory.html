<!--
/**
 *  The MIT License
 *
 *  Copyright (c) 2010 Simone Vicentini
 *
 *  Permission is hereby granted, free of charge, to any person obtaining a copy
 *  of this software and associated documentation files (the "Software"), to deal
 *  in the Software without restriction, including without limitation the rights
 *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 *  copies of the Software, and to permit persons to whom the Software is
 *  furnished to do so, subject to the following conditions:
 *
 *  The above copyright notice and this permission notice shall be included in
 *  all copies or substantial portions of the Software.
 *
 *  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 *  THE SOFTWARE.
 */
 -->
	<html>
	<head>
	<script type="text/javascript" src="scripts/jquery-1.3.2.js"></script>
	<script type="text/javascript" src="scripts/object.js"></script>
	<script type="text/javascript" src="scripts/array.js"></script>
	<script type="text/javascript" src="scripts/linked-list.js"></script>
	<script type="text/javascript" src="scripts/linebreak.js"></script>
	<script type="text/javascript" src="scripts/formatter.js"></script>
	<script>
	function draw(context, xOffset, yOffset, fontHeight, nodes, breaks, lineLengths, drawRatio, center) {
		var i = 0, lines = [], point, j, r, lineStart = 0, y = 4 + yOffset, tmp, maxLength = Math.max.apply(null, lineLengths);

		// Iterate through the line breaks, and split the nodes at the
		// correct point.
		for (i = 1; i < breaks.length; i += 1) {
			point = breaks[i].position,
			r = breaks[i].ratio;

			for (var j = lineStart; j < nodes.length; j += 1) {
				// After a line break, we skip any nodes unless they are boxes or forced breaks.
				if (nodes[j].type === 'box' || (nodes[j].type === 'penalty' && nodes[j].penalty === -linebreak.defaults.infinity)) {
					lineStart = j;
					break;
				}
			}
			lines.push({ratio: r, nodes: nodes.slice(lineStart, point + 1), position: point});
			lineStart = point;
		}

		lines.forEach(function (line, lineIndex) {
			var x = xOffset, lineLength = lineIndex < lineLengths.length ? lineLengths[lineIndex] : lineLengths[lineLengths.length - 1];

			if (center) {
				x += (maxLength - lineLength) / 2;

			}

			line.nodes.forEach(function (node, index) {
				if (node.type === 'box') {
					context.fillText(node.value, x, y);
					x += node.width;
				} else if (node.type === 'glue') {
					x += node.width + line.ratio * (line.ratio < 0 ? node.shrink : node.stretch);
				}
			});

			if (drawRatio) {
				context.textAlign = 'right';
				context.fillText(line.ratio.toFixed(3), context.canvas.width, y);
				context.textAlign = 'left';
			}

			//y += 21;
			y += fontHeight+7;
		});
		return lines;
	}


	function align(text, xOffset, yOffset, font, fontHeight, identifier, type, lineLengths, tolerance, drawRatio, center) {
		var canvas = $(identifier).get(0),
			context = canvas.getContext && canvas.getContext('2d'),
			format, nodes, breaks;

		if (context) {
			context.textBaseline = 'top';
			//context.font = "14px 'times new roman', 'FreeSerif', serif";
			context.font = fontHeight+"px "+font;

			format = formatter(function (str) {
				return context.measureText(str).width;
			});

			nodes = format[type](text);

			breaks = linebreak(nodes, lineLengths, {tolerance: tolerance});

			if (!breaks.isEmpty()) {
				return draw(context, xOffset, yOffset, fontHeight, nodes, breaks, lineLengths, drawRatio, center);
			} else {
				context.fillText('Paragraph can not be set with the given tolerance.', 0, 0);
			}
		}
		return [];
	};



	function drawCard(data, x, y, width, height)
	{
		//Get a reference to the element.
		var elem = document.getElementById('myCanvas');

		// Always check for properties and methods, to make sure your code doesn't break
		// in other browsers.
		if (elem && elem.getContext) {
		  // Get the 2d context.
		  // Remember: you can only initialize one context per element.
		  var context = elem.getContext('2d');
		  if (context)
		  {

			  context.fillStyle   = '#fff';
			  context.strokeStyle = '#000';
			  context.lineWidth   = 1;
			  context.fillRect  (x,  y, width, height);
			  context.strokeRect(x,  y, width, height);

			  context.fillStyle   = '#000';
			  var font = "sans-serif";
			  var fontHeight = 15;
		      align("ID: "+data.id, x+10, y+0, font, fontHeight, '#myCanvas', 'justify', [width - 20], 100, false);
			  font = "sans-serif";
			  fontHeight = 15;
		      align(data.name, x+10, y+30, font, fontHeight, '#myCanvas', 'justify', [width - 20], 100, false);
			  font = "sans-serif";
			  fontHeight = 15;
		      align(data.estimate, x + width - 10, y + height - 10 - fontHeight, font, fontHeight, '#myCanvas', 'justify', [20], 100, false);
		      font = "sans-serif";
			  fontHeight = 15;
		      align(data.labels, x+10, y + height - 10 - fontHeight, font, fontHeight, '#myCanvas', 'left', [width - 20], 100, false);
	          context.drawImage(document.getElementById(data.story_type), x+width-50, y+10);
		  }
		}
	}

	var pivotalTackerPtojectId = "64927";
	var pivotalTrackerStoryRequest = "http://www.pivotaltracker.com/services/v3/projects/"+pivotalTackerPtojectId+"/stories";


	function retrieveStories(filter)
	{
		getStoryXmlRequest=new XMLHttpRequest();
		getStoryXmlRequest.open( "get", pivotalTrackerStoryRequest+"?filter="+filter, true );

		getStoryXmlRequest.setRequestHeader("X-TrackerToken", "f121a7e0ea9052c4fcb4ea16c4406edc");

		getStoryXmlRequest.onload = onStoryRetreived;
		getStoryXmlRequest.send();
	}



	function requestStory(storyId)
	{
		getStoryXmlRequest=new XMLHttpRequest();
		getStoryXmlRequest.open( "get", pivotalTrackerStoryRequest+"/"+storyId, true );

		getStoryXmlRequest.setRequestHeader("X-TrackerToken", "f121a7e0ea9052c4fcb4ea16c4406edc");

		getStoryXmlRequest.onload = onStoryRetreived;
		getStoryXmlRequest.send();

	}


	function getTextContentForElement(src, elementTag)
	{
		var elements = src.getElementsByTagName(elementTag);
		if (elements.length > 0)
			return elements[0].textContent;
		return "";
	}

	var typeX = 0;
	var jsonStory;
	function onStoryRetreived()
	{
		var stories = getStoryXmlRequest.responseXML.getElementsByTagName("story");

		var i = 0;
		var x = typeX;
		var y = 50;
		while (i < stories.length)
		{

			var story = stories[i];
			jsonStory = {
					"name":getTextContentForElement(story, "name"),
					"id":getTextContentForElement(story, "id"),
					"story_type":getTextContentForElement(story, "story_type"),
					"estimate":getTextContentForElement(story, "estimate"),
					"current_state":getTextContentForElement(story, "current_state"),
					"description":getTextContentForElement(story, "description"),
					"labels":getTextContentForElement(story, "labels")
			};


			drawCard(jsonStory, x, y, 300, 200);
			i++;
			y = 50 + i * 220;
		}

		var title;
		if (current_state == "started")
		{
			title = "In Development";
			current_state = "finished";
			typeX = 320;
			retrieveStories("state:"+current_state);
		}
		if (current_state == "finished")
		{
			title = "Ready to Test";
			current_state = "delivered"
			typeX = 640;
			retrieveStories("state:"+current_state);
		}
		if (current_state == "delivered")
		{
			title = "Ready to be Accepted";
		}


		var font = "sans-serif";
		var fontHeight = 15;
	    align(title, typeX + 50, 0, font, fontHeight, '#myCanvas', 'justify', [100], 100, false);


	}

	var current_state = "started";
	retrieveStories("state:"+current_state);
	//finished, delivered, accepted, or rejected.



	//requestStory("2283694");
</script>

</head>
<body>
<canvas id="myCanvas" width="2000" height="5000">
</canvas>
<img id="chore" src="images/chore_icon.png" style="display:none">
<img id="feature" src="images/feature_icon.png"  style="display:none">
</body>
</html>
